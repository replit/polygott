#!/bin/bash
set -ev
shopt -s dotglob

export HOME=/home/runner
(cd /home/runner && \
 mkdir -p /opt/homes/default && \
 mkdir -p /opt/virtualenvs && \
 mv -nt /opt/homes/default/ $(ls -A /home/runner))

<% for ( let lang of languages ) { -%>
<% if (!lang.setup) continue; -%>
if [[ -z "${LANGS}" || ",${LANGS}," == *",<%= lang.id %>,"* ]]; then
	echo 'Setup <%= lang.name %>'
<% for ( let line of lang.setup ) { -%>
  <%- undup(line) %>
<% } -%>

	if [ -n "$(ls -A /home/runner)" ]; then
		echo Storing home for <%= lang.name %>
		mkdir -p /opt/homes/<%= lang.name %>
		cp -r /opt/homes/default/* /opt/homes/<%= lang.name %>
		mv -nt /opt/homes/<%= lang.name %>/ /home/runner/*
		ls -A /opt/homes/<%= lang.name %>
	fi
fi

<% } -%>

chown runner:runner -R /opt/homes
cp -r /opt/homes/default/* /home/runner
chown runner:runner -R /home/runner
chown runner:runner -R /config
chown runner:runner -R /opt/virtualenvs

rm -rf /var/lib/apt/lists/*
rm /phase2.sh
