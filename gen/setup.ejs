#!/bin/bash
set -v
shopt -s dotglob

# Languages: <%= languages.map((l) => l.name).join(', ') %>

groupadd -g 1000 runner
useradd -m -d /home/runner -g runner -s /bin/bash runner --uid 1000 --gid 1000

apt-get update

DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends <%- packages.join(' ') %> || exit 1

update-ca-certificates

curl -sL https://deb.nodesource.com/setup_10.x | bash -
DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
npm install -g yarn

cd /home/runner
mkdir -p /opt/homes/default
mv -nt /opt/homes/default/ $(ls -A /home/runner)

<% for ( let lang of languages ) { -%>
<% if ( lang.setup ) { -%>


echo Setup <%= lang.name %>
<% for ( let line of lang.setup ) { -%>
<%- undup(line) %>
<% } -%>

if [ -n "$(ls -A /home/runner)" ]; then
	echo Storing home for <%= lang.name %>
	mkdir -p /opt/homes/<%= lang.name %>
	cp -r /opt/homes/default/* /opt/homes/<%= lang.name %>
	mv -nt /opt/homes/<%= lang.name %>/ /home/runner/*
	ls -A /opt/homes/<%= lang.name %>
fi
<% } -%>
<% } -%>



cp -r /opt/homes/default/* /home/runner
chown runner:runner -R /home/runner

rm -rf /var/lib/apt/lists/*
rm /setup.sh
