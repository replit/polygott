#!/bin/bash
set -v
shopt -s dotglob

# Languages: <%= languages.map((l) => l.name).join(', ') %>

groupadd -g 1000 runner
useradd -m -d /home/runner -g runner -s /bin/bash runner --uid 1000 --gid 1000

apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends busybox software-properties-common apt-utils dirmngr gpg-agent


<% for ( let key of aptKeys ) { %>
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv <%- c([key]) %>
<% } %>

<% for ( let repo of aptRepos ) { %>
add-apt-repository -y <%- c([repo]) %>
<% } %>

apt-get update

DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends <%- packages.join(' ') %> || exit 1

update-ca-certificates

curl -sL https://deb.nodesource.com/setup_10.x | bash -
DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
npm install -g yarn

cd /home/runner
mkdir -p /opt/homes/default
mv -nt /opt/homes/default/ $(ls -A /home/runner)


rm -rf /var/lib/apt/lists/*
rm /phase1.sh
