version: v1.0
name: Polygott
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
blocks:
  - name: Build image
    dependencies: []
    task:
      jobs:
        - name: Build
          commands:
            - checkout
            - make image
  - name: All tests
    dependencies: ["Build image"]
    task:
      jobs:
        - name: Test
          commands:
            - make test
  - name: Changed language tests
    dependencies: ["Build image"]
    task:
      jobs:
        - name: Changed test
          commands:
            - make changed-test
promotions:
  - name: Docker Hub
    pipeline_file: docker-hub-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
         - "^master$"
